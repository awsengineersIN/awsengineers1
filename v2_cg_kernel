{
  "schemaVersion": "2.2",
  "description": "Remove old kernels, retaining the latest two (including the currently running one), clean up associated files, update GRUB, and log disk space usage. Supports dry run with DryRun=1 parameter. Automatically removes duplicate kernel entries if found.",
  "parameters": {
    "DryRun": {
      "type": "String",
      "description": "Set to 1 to simulate removal without making changes.",
      "default": "0",
      "allowedValues": ["0", "1"]
    }
  },
  "mainSteps": [
    {
      "action": "aws:runShellScript",
      "name": "RemoveOldKernels",
      "inputs": {
        "runCommand": [
          "#!/bin/bash",
          "set -e",
          "trap 'echo [$(date \"+%Y-%m-%d %H:%M:%S\")] Error: Script exited unexpectedly' ERR",
          "",
          "echo \"[$(date '+%Y-%m-%d %H:%M:%S')] Starting kernel cleanup\"",
          "",
          "if [ \"$EUID\" -ne 0 ]; then",
          "  echo \"[$(date '+%Y-%m-%d %H:%M:%S')] Error: This script must be run as root\"",
          "  exit 1",
          "fi",
          "",
          "current_kernel=$(uname -r)",
          "echo \"[$(date '+%Y-%m-%d %H:%M:%S')] Current kernel: $current_kernel\"",
          "echo \"[$(date '+%Y-%m-%d %H:%M:%S')] Disk usage before cleanup:\"",
          "df -h /boot",
          "",
          "# Fetch installed kernels and normalize duplicates",
          "installed_kernels=$(rpm -q kernel | sort -V | uniq) || { echo \"[$(date '+%Y-%m-%d %H:%M:%S')] Error: Failed to list kernels\"; exit 1; }",
          "echo \"[$(date '+%Y-%m-%d %H:%M:%S')] Installed kernels:\"",
          "echo \"$installed_kernels\"",
          "",
          "kernel_count=$(echo \"$installed_kernels\" | wc -l)",
          "if [ \"$kernel_count\" -le 2 ]; then",
          "  echo \"[$(date '+%Y-%m-%d %H:%M:%S')] Fewer than or equal to 2 kernels installed ($kernel_count). No action needed.\"",
          "  df -h /boot",
          "  exit 0",
          "fi",
          "",
          "kernels_to_keep=$(echo \"$installed_kernels\" | grep \"$current_kernel\")",
          "latest_other_kernel=$(echo \"$installed_kernels\" | grep -v \"$current_kernel\" | tail -n 1)",
          "if [ -n \"$latest_other_kernel\" ]; then",
          "  kernels_to_keep=\"$kernels_to_keep\\n$latest_other_kernel\"",
          "fi",
          "echo \"[$(date '+%Y-%m-%d %H:%M:%S')] Kernels to keep:\"",
          "echo \"$kernels_to_keep\"",
          "",
          "if [ \"{{DryRun}}\" = \"1\" ]; then",
          "  echo \"[$(date '+%Y-%m-%d %H:%M:%S')] DRY RUN: No kernels will be removed\"",
          "fi",
          "",
          "for kernel in $installed_kernels; do",
          "  if ! echo \"$kernels_to_keep\" | grep -q \"$kernel\"; then",
          "    echo \"[$(date '+%Y-%m-%d %H:%M:%S')] Processing kernel: $kernel\"",
          "    if [ \"{{DryRun}}\" = \"1\" ]; then",
          "      echo \"[$(date '+%Y-%m-%d %H:%M:%S')] DRY RUN: Would remove kernel: $kernel\"",
          "    else",
          "      echo \"[$(date '+%Y-%m-%d %H:%M:%S')] Removing kernel: $kernel\"",
          "      yum remove -y \"$kernel\" || { echo \"[$(date '+%Y-%m-%d %H:%M:%S')] Error: Failed to remove $kernel\"; exit 1; }",
          "    fi",
          "  else",
          "    echo \"[$(date '+%Y-%m-%d %H:%M:%S')] Retaining kernel: $kernel\"",
          "  fi",
          "done",
          "",
          "if [ \"{{DryRun}}\" != \"1\" ]; then",
          "  echo \"[$(date '+%Y-%m-%d %H:%M:%S')] Updating GRUB configuration\"",
          "  grub2-mkconfig -o /boot/grub2/grub.cfg || { echo \"[$(date '+%Y-%m-%d %H:%M:%S')] Error: Failed to update GRUB\"; exit 1; }",
          "else",
          "  echo \"[$(date '+%Y-%m-%d %H:%M:%S')] DRY RUN: Would update GRUB configuration\"",
          "fi",
          "",
          "echo \"[$(date '+%Y-%m-%d %H:%M:%S')] Disk usage after cleanup:\"",
          "df -h /boot",
          "",
          "echo \"[$(date '+%Y-%m-%d %H:%M:%S')] Kernel cleanup completed successfully\""
        ]
      }
    }
  ]
}
